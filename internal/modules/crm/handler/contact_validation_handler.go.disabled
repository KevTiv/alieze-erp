package handler

import (
	"encoding/json"
	"net/http"

	"github.com/KevTiv/alieze-erp/internal/modules/crm/service"
	"github.com/KevTiv/alieze-erp/internal/modules/crm/types"
	"github.com/google/uuid"
	"github.com/julienschmidt/httprouter"
)

// ContactValidationHandler handles contact validation HTTP requests
type ContactValidationHandler struct {
	validationService *service.ContactValidationService
}

// NewContactValidationHandler creates a new validation handler
func NewContactValidationHandler(validationService *service.ContactValidationService) *ContactValidationHandler {
	return &ContactValidationHandler{
		validationService: validationService,
	}
}

// ValidateContact handles POST /api/crm/contacts/validate
func (h *ContactValidationHandler) ValidateContact(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	ctx := r.Context()

	// Get organization ID from context
	orgID, err := getOrganizationIDFromContext(ctx)
	if err != nil {
		http.Error(w, "organization not found in context", http.StatusUnauthorized)
		return
	}

	// Parse request
	var req types.ContactValidateRequest
	if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
		http.Error(w, "invalid request body", http.StatusBadRequest)
		return
	}

	// Validate contact
	result, err := h.validationService.ValidateContact(ctx, orgID, req)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	// Return result
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(result)
}

// GetValidationRules handles GET /api/crm/contacts/validation-rules
func (h *ContactValidationHandler) GetValidationRules(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	ctx := r.Context()

	// Get organization ID from context
	orgID, err := getOrganizationIDFromContext(ctx)
	if err != nil {
		http.Error(w, "organization not found in context", http.StatusUnauthorized)
		return
	}

	// Get validation rules
	rules, err := h.validationService.GetValidationRules(ctx, orgID)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	// Return rules
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(rules)
}

// EnrichContact handles POST /api/crm/contacts/:id/enrich
func (h *ContactValidationHandler) EnrichContact(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
	ctx := r.Context()

	// Get organization ID from context
	orgID, err := getOrganizationIDFromContext(ctx)
	if err != nil {
		http.Error(w, "organization not found in context", http.StatusUnauthorized)
		return
	}

	// Parse contact ID
	contactID, err := uuid.Parse(ps.ByName("id"))
	if err != nil {
		http.Error(w, "invalid contact ID", http.StatusBadRequest)
		return
	}

	// Parse request (optional body)
	var req types.ContactEnrichRequest
	req.ContactID = contactID
	if r.Body != nil {
		json.NewDecoder(r.Body).Decode(&req)
	}

	// Enrich contact
	result, err := h.validationService.EnrichContactData(ctx, orgID, req)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	// Return result
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(result)
}

// GetDataSuggestions handles GET /api/crm/contacts/:id/suggestions
func (h *ContactValidationHandler) GetDataSuggestions(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
	ctx := r.Context()

	// Get organization ID from context
	orgID, err := getOrganizationIDFromContext(ctx)
	if err != nil {
		http.Error(w, "organization not found in context", http.StatusUnauthorized)
		return
	}

	// Parse contact ID
	contactID, err := uuid.Parse(ps.ByName("id"))
	if err != nil {
		http.Error(w, "invalid contact ID", http.StatusBadRequest)
		return
	}

	// Get suggestions
	suggestions, err := h.validationService.GetDataSuggestions(ctx, orgID, contactID)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	// Return suggestions
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(suggestions)
}
